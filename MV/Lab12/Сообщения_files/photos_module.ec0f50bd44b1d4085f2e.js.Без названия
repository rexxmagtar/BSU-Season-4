!function(e){function t(t){for(var s,o,h=t[0],n=t[1],d=t[2],l=0,g=[];l<h.length;l++)o=h[l],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&g.push(i[o][0]),i[o]=0;for(s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s]);for(u&&u(t);g.length;)g.shift()();return r.push.apply(r,d||[]),a()}function a(){for(var e,t=0;t<r.length;t++){for(var a=r[t],s=!0,h=1;h<a.length;h++){var n=a[h];0!==i[n]&&(s=!1)}s&&(r.splice(t--,1),e=o(o.s=a[0]))}return e}var s={},i={"web/photos_module":0},r=[];function o(t){if(s[t])return s[t].exports;var a=s[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,o),a.l=!0,a.exports}o.m=e,o.c=s,o.d=function(e,t,a){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(o.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(a,s,function(t){return e[t]}.bind(null,s));return a},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/js/cmodules/";var h=window.webpackJsonp=window.webpackJsonp||[],n=h.push.bind(h);h.push=t,h=h.slice();for(var d=0;d<h.length;d++)t(h[d]);var u=n;r.push([217,"bundles/common","bundles/92d561a0bfe326994ae42c79e0aa3e55"]),a()}({217:function(e,t,a){e.exports=a("Lrwn")},Lrwn:function(e,t,a){"use strict";a.r(t);var s=a("g/In"),i=a("yTQ2");window.PhotoTags=s.default,window.PhotoTooltip=i.default;try{stManager.done(jsc("web/photos_module.js"))}catch(e){}},"g/In":function(e,t,a){"use strict";a.r(t);a("HEwt"),a("a1Th"),a("Btvt"),a("rGqo"),a("rE2o"),a("ioFf"),a("KKXr");var s=a("zxIV"),i=a("EasH"),r=a("4+be"),o=a("yTQ2"),h=a("Nk8j");function n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],s=!0,i=!1,r=void 0;try{for(var o,h=e[Symbol.iterator]();!(s=(o=h.next()).done)&&(a.push(o.value),!t||a.length!==t);s=!0);}catch(e){i=!0,r=e}finally{try{s||null==h.return||h.return()}finally{if(i)throw r}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return d(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,s=new Array(t);a<t;a++)s[a]=e[a];return s}t.default=class{constructor(e,t){this.imageNode=e,this.containerNode=t,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this._updatePhotoView=this._updatePhotoView.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}_init(){this.photoTooltip=new o.default(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined}),this.photoView=window.Photoview,this.areasContainer=ce("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),addEvent(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()}_handleImageMouseMove(e){if(!this.areasHidden){var t=getXY(e.target),a=Math.round(100*(e.pageX-t[0])/e.target.offsetWidth),s=Math.round(100*(e.pageY-t[1])/e.target.offsetHeight);for(var i in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout(()=>{this.photoTooltip.isActive||this.activeAreaId||this.hideAllSuggestedAreas()},700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(i)){var r=this.areas[i],o=r.x,h=r.y,n=r.x2,d=r.y2;if(a>parseInt(o)&&a<parseInt(n)&&s>parseInt(h)&&s<parseInt(d)){if(i===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(i),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}}_handleAreaClick(e){cancelEvent(e),this.photoTooltip.showAndFocusFriendsList(e)}showTagArea(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,addClass(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)}hideTagArea(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()}_removeActiveAreaAfterTimeout(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout(()=>{!this.photoTooltip.isActive&&!this.tagAreaFound&&!this.photoTooltip.interaction&&this.hideTagArea(),this.waitToRemove=!1},e))}showTooltip(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,a=this._getTooltipOptions(e);if(t){var i=Object(s.getXYRect)(t,!0),r=i.top,o=i.right,h=i.bottom,n=i.left;this.photoTooltip.show({top:r,right:o,bottom:h,left:n},a)}}}showAllSuggestedAreas(){addClass(this.areasContainer,"visible_all"),removeClass(this.areasContainer,"area_hover"),this.activeAreaId&&addClass(this.areasContainer,"area_hover")}hideAllSuggestedAreas(){removeClass(this.areasContainer,"visible_all")}pauseTooltips(){this.hideTagArea(),this.tooltipsPaused=!0}resumeTooltips(){this.tooltipsPaused=!1}_createTagElement(e,t,a,s){var i=cur.pvPhWidth,r=cur.pvPhHeight/i,o=a-e,h=s-t,n=ce("div",{className:"photo_tags_suggested_area"},{left:e+"%",marginTop:r*t+"%",width:o+"%"}),d=ce("div",{},{paddingBottom:100*r*(h/o)+"%"});return n.appendChild(d),n}renderTagAreas(){this.areas={},this.areasContainer.innerHTML="";var e=Object(h.getPhotoData)("tags"),t=Object(h.getPhotoData)("suggested_tags");for(var a in cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==a&&e.hasOwnProperty(a)){var s=n(e[a],7),i=s[0],r=s[1],o=s[2],d=s[3],u=s[4],l=s[5],g=s[6],c=this._createTagElement(i,r,o,d);this.areas[a]={ele:c,x:i,y:r,x2:o,y2:d,userName:u,userHref:l,canDeleteTag:Boolean(g),confirmedTag:!1},this.areasContainer.appendChild(c)}for(var v in t)if(v&&t.hasOwnProperty(v)){var p=n(t[v],7),m=p[0],f=p[1],A=p[2],T=p[3],_=p[4],b=p[5],w=p[6],y=this._createTagElement(m,f,A,T),P=void 0;_&&(P="/id"+_),this.areas[v]={ele:y,x:m,y:f,x2:A,y2:T,userHref:P,suggestedUserId:_,suggestedUserName:b,usersList:w,confirmedTag:!1},this.areasContainer.appendChild(y)}}_userSelectedCallback(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=Object(h.getPhotoData)("tags"),i=Object(h.getPhotoData)("suggested_tags"),r=this.activeAreaId,o=this.areas[r],n=o.x,d=o.y,u=o.x2,l=o.y2,g="/id"+e,c=cur.pvAskForAutoTag&&a,v=clean(t);s[r]=[n,d,u,l,v,g,!0],delete i[r];var p={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:v,userHref:g,canDeleteTag:!0},m=this.activeAreaId;this._confirmSuggestedTag(r,e,t,()=>{this.activeAreaId=m,this.areas[m]=extend(o,p),this.photoTooltip.updateState(p),this.showTagArea(m),this._removeActiveAreaAfterTimeout(1e3),c&&(cur.pvAskForAutoTag=!1,this.showSettingsBox())})}showSettingsBox(){showBox("/al_photos.php",{act:"show_autotag_settings"},{params:{containerClass:"autotag_settings_box",grey:!0,width:450}})}deleteTag(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=extend(t,{isDeleted:!0}),addClass(t.ele,"deleted"))}_getTooltipOptions(e){var t=this.areas[e],a=t.suggestedUserId,s=t.suggestedUserName;return{suggestedUserId:a,userName:t.userName,userHref:t.userHref,suggestedUserName:s,usersList:t.usersList,canDeleteTag:t.canDeleteTag}}_handleSuggestionDeclined(){var e=this.activeAreaId,t=this.areas[e];if(t){var a=Object(h.getPhotoData)("suggested_tags");this.areas[e]=extend(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),this.showTagArea(e),a&&a[e]&&(a[e][4]=0);var s=Object(h.getPhotoData)("id"),i=Object(h.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:s,hash:i},{onFail:this.handleTagRequestFail})}}_confirmSuggestedTag(e,t,a,s){var i=Object(h.getPhotoData)("id"),r=Object(h.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:a,photo:i,hash:r},{onDone:(e,t,a)=>{this._updatePhotoView(e,t,a),s()},onFail:this.handleTagRequestFail})}handleTagRequestFail(e){var t=Object(r.getLang)("global_error");return setTimeout(Object(i.showFastBox)(t,e).hide,3e3),!0}unMount(){removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),removeEvent(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""}hideAreas(){this.areasHidden=!0,hide(this.areasContainer),this.photoTooltip.hide()}showAreas(){this.areasHidden=!1,show(this.areasContainer),removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove)}reload(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()}_queueCheckUpdates(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)}_updatePhotoView(e,t,a){Object(h.setPhotoData)("tags",e),Object(h.setPhotoData)("tagged",t),Object(h.setPhotoData)("tagshtml",a),this.photoView.setTags(a)}_queueReceiveUpdates(e,t){t.events&&t.events.forEach(e=>{var t=e.split("<!>"),a=t[1],s=t[2],i=JSON.parse(s),r=JSON.parse(t[3]),o=JSON.parse(t[4]),n=t[5];if(Object(h.getPhotoData)("id")===a)Object(h.setPhotoData)("suggested_tags",i),this._updatePhotoView(r,o,n),this.renderTagAreas();else if(cur.pvData){var d=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach((t,s)=>{if(t.id&&t.id===a){var h=cur.pvData[e][s];h.suggested_tags=i,h.tags=r,h.tagged=o,h.tagshtml=n}})}};for(var u in cur.pvData)d(u)}})}}}});