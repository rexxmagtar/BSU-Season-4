!function(e){function t(t){for(var i,l,s=t[0],r=t[1],d=t[2],u=0,c=[];u<s.length;u++)l=s[u],Object.prototype.hasOwnProperty.call(n,l)&&n[l]&&c.push(n[l][0]),n[l]=0;for(i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);for(p&&p(t);c.length;)c.shift()();return a.push.apply(a,d||[]),o()}function o(){for(var e,t=0;t<a.length;t++){for(var o=a[t],i=!0,s=1;s<o.length;s++){var r=o[s];0!==n[r]&&(i=!1)}i&&(a.splice(t--,1),e=l(l.s=o[0]))}return e}var i={},n={"web/upload":0},a=[];function l(t){if(i[t])return i[t].exports;var o=i[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,l),o.l=!0,o.exports}l.m=e,l.c=i,l.d=function(e,t,o){l.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,t){if(1&t&&(e=l(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(l.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)l.d(o,i,function(t){return e[t]}.bind(null,i));return o},l.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(t,"a",t),t},l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.p="/js/cmodules/";var s=window.webpackJsonp=window.webpackJsonp||[],r=s.push.bind(s);s.push=t,s=s.slice();for(var d=0;d<s.length;d++)t(s[d]);var p=r;a.push([274,"bundles/common"]),o()}({274:function(e,t,o){e.exports=o("CtBR")},CtBR:function(e,t,o){"use strict";o.r(t);o("NO8f"),o("a1Th"),o("Btvt"),o("SRfc"),o("Oyvg"),o("pIFo"),o("KKXr");var i=o("EasH"),n=o("jE6c"),a=o("Bj12"),l={c:1,h:{},reg:function(e){return l.h[l.c]=Object(n.isFunction)(e)?e:function(){},l.c++}},s={init:function(e,t,o,i){window.uploadInterface=void 0!==window.uploadInterface?window.uploadInterface+1:0;var n=window.uploadInterface;return each(["obj","dropbox","options","vars","types","uploadUrls","callbacks","checks","dragTimer"],(function(e,t){s[t]||(s[t]={})})),this.obj[n]=ge(e),i.dropbox&&(this.dropbox[n]=ge(i.dropbox)),this.vars[n]=o,i.file_input=ge(i.file_input),this.options[n]=i,i.clear&&cur.destroy.push(s.deinit.pbind(n)),this.uploadUrls[n]=t,!i.flash_lite||browser.flash||this.checkFileApi()?i.customShowProgress?i.customShowProgress():"INPUT"!==this.obj[n].tagName||this.checkFileApi()?i.flash_lite||(this.obj[n].innerHTML='<div class="upload_check loading">'+getProgressHtml("","pr_medium upload_pr")+"</div>"):this.obj[n]=ge(i.fieldEl)||this.obj[n].parentNode.firstChild:this.obj[n]=ge(i.fieldEl)||this.obj[n].parentNode.firstChild,i.noCheck?this.embed(n):this.check(n),n},deinit:function(e){if(s.obj[e]){var t=(s.options[e]||{}).dragEvObj,o=s.obj[e];if(t&&(removeEvent(t,"dragenter"),removeEvent(t,"dragover"),removeEvent(t,"dragleave")),o.innerHTML="",each(["obj","dropbox","options","vars","types","uploadUrls","callbacks"],(function(t,o){s[o]&&delete s[o][e]})),s.callbacks){var i=["oncheck","ondone","onfail"];each(s.flashCallbacks(),(function(e,t){i.push(e)})),each(i,(function(t,o){delete s.callbacks[o+e]}))}clearTimeout(s.checks["timer"+e]),clearTimeout(s.dragTimer[e]),delete s.dragTimer[e]}},check:function(e){var t=this.obj[e],o=this.vars[e],i=this.options[e],n=i.check_url?i.check_url:this.uploadUrls[e],a={};if(i.signed){if(!n)return s.onCheckComplete(e);extend(a,{_jsonp:l.reg((function(t){s.onCheckComplete(e,t)}))})}else{if(!i.check_hash&&!i.server)return s.onCheckComplete(e);this.callbacks["oncheck"+e]=s.onCheckComplete.pbind(e);var r=["mid","aid","gid","hash","rhash"];for(var d in r)r.hasOwnProperty(d)&&(a[r[d]]=o[r[d]]);i.check_aid&&(a.aid=i.check_aid),i.check_gid&&(a.gid=i.check_gid),i.check_hash&&(a.hash=i.check_hash),i.check_rhash&&(a.rhash=i.check_rhash),o.https_resp&&(a.https_resp=o.https_resp),extend(a,{al:1,act:"check_upload",type:i.type,ondone:"Upload.callbacks.oncheck"+e})}var p='<form action="'+n+'" enctype="multipart/form-data" method="post" id="check_upload_form'+e+'" target="check_iframe'+e+'">';for(var u in a)a.hasOwnProperty(u)&&(p+='<input type="hidden" name="'+u+'" value="'+a[u]+'" />');p+='</form><iframe style="visibility: hidden; width: 1px; height: 1px;" id="check_iframe'+e+'" name="check_iframe'+e+'"></iframe>';var c=ce("div",{id:"check_upload_"+e,innerHTML:p,className:i.checkClass||""},{display:"none"});ge("check_upload_"+e)&&re("check_upload_"+e),t.appendChild(c);var h=ge("check_upload_form"+e);if(h)try{h&&h.submit(),clearTimeout(s.checks["timer"+e]),this.checks["timer"+e]=setTimeout(s.serverFail.pbind(e),1e4)}catch(e){debugLog(e)}},onCheckComplete:function(e,t){clearTimeout(s.checks["timer"+e]),delete s.checks["timer"+e];var o={},i=s.options[e],n=t;if(i.signed)o=parseJSON(t||"{}");else{for(var a in t=(t=t||"").split("&"))if(t.hasOwnProperty(a)){var l=t[a].split("=");o[l[0]]=l[1]}n=o}i.customHideProgress&&i.customHideProgress(),o.error||o.fail?s.serverFail(e,n):(i.noCheck=1,i.onCheckComplete?i.onCheckComplete(e):i.flash_lite&&browser.flash?s.initFlash(e,s.obj[e]):s.embed(e),s.serverSuccess(e,n))},serverFail:function(e,t){var o=s.obj[e],n=s.options[e],a=s.vars[e];if(o&&(n.signed||n.server))if(s.fails||(s.fails={}),s.fails[e]=s.fails[e]?s.fails[e]+1:1,n.signed){var l=s.uploadUrls[e].split("?"),r=AjaxConvert.fromQueryString(l[1]),d=extend({act:"check_result",_resign:r._query||l[1]},t?{_query:t}:{_check:n.check_url.split("?")[1]});ajax.post("upload_fails.php",d,{onDone:function(t,a,l,r){s.fails[e]<n.max_attempts?(s.uploadUrls[e]=t,extend(s.options[e],{check_url:a,base_url:l,static_url:r}),s.check(e)):(o.innerHTML="",n.lang&&n.lang.cannot_upload_title&&n.lang.cannot_upload_text&&Object(i.showFastBox)({title:n.lang.cannot_upload_title,width:430,dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},n.lang.cannot_upload_text))}})}else{var p=extend({act:"fail",role:n.type,mid:a.mid,oid:a.oid,gid:a.gid,aid:a.aid,server:n.server,st2_server:n.st2_server,error:n.error,hash:n.error_hash,hash_extra:a.hash_extra},t);n.custom_hash&&extend(p,{custom_hash:n.custom_hash,photo_hash:a.photo_hash,size:a.size,fid:a.fid,vid:a.vid,tag:a.tag}),a.transform_entry&&extend(p,{transform_entry:a.transform_entry,transform_hash:a.transform_hash,security_hash:a.security_hash}),ajax.post("upload_fails.php",p,{onDone:function(t,a,l){s.fails[e]<n.max_attempts?(s.uploadUrls[e]=t,extend(s.options[e],l),extend(s.vars[e],a),s.check(e)):(o.innerHTML="",n.lang&&n.lang.cannot_upload_title&&n.lang.cannot_upload_text&&Object(i.showFastBox)({title:n.lang.cannot_upload_title,width:430,dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},n.lang.cannot_upload_text))}})}},serverSuccess:function(e,t){var o=s.options[e],i=s.vars[e];if(s.checked=s.checked||{},s.checked[e]=1,o.signed)ajax.post("upload_fails.php",{act:"check_result",_query:t});else if(o.server||o.error_hash){var n=extend({act:"success",mid:i.mid,oid:i.oid,gid:i.gid,aid:i.aid,server:o.server,error:o.error,hash:o.error_hash},t);ajax.post("upload_fails.php",n)}},embed:function(e){var t=null!=e.num?e.num:e,o=this.obj[t],i=this.dropbox[t],n=this.options[t];n.noEmbed?re("check_upload_"+e):n.noCheck&&(browser.flash>9&&n.forceFlash?this.initFlash(t,o):this.checkFileApi()&&!n.flash_lite?this.initFileApi(t,o,i):browser.flash>9&&!n.noFlash?this.initFlash(t,o):n.noForm||this.initForm(t,o))},checkFileApi:function(){return(window.XMLHttpRequest||window.XDomainRequest)&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&(window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder)))},initFlash:function(e,t){var o=[],i=s.vars[e],n=s.options[e],a={url:n.flashPath||"/swf/uploader_lite.swf",id:"uploader_lite"+e,preventhide:!0,width:"100%",height:browser.safari||browser.msie||browser.chrome&&intval(browser.version)<17?n.flashHeight?n.flashHeight+"px":cur.flash_lite&&!isVisible("photos_flash_add_button")?"67px":"25px":"100%"},l={swliveconnect:"true",allowscriptaccess:"always",wmode:browser.msie?"opaque":"transparent"};for(var r in s.types[e]="flash",i)i.hasOwnProperty(r)&&o.push(r+"="+i[r]);n.signed||i.ajx||o.push("ajx=1");var d=this.flashCallbacks(),p={};this.callbacks=this.callbacks||{},each(d,(function(t,o){s.callbacks[t+e]=o.pbind(e),p[t]="Upload.callbacks."+t+e}));var u=clone(i);if(extend(u,p,{upload_url:s.uploadUrls[e],file_size_limit:n.file_size_limit,file_types_description:n.file_types_description,file_types:n.file_types,file_name:n.file_name,post_data:escape(o.join("&"))}),n.flash_lite?t.innerHTML='<div class="lite_upload" id="lite_upload'+e+'" style="z-index:10000; width: 100%; height: 100%; cursor: pointer;"></div>':(n.lang.button_browse||(n.lang.button_browse="Выбрать файл"),n.flat_button?t.innerHTML='<div id="uploader'+e+'" style="position: relative;"><div id="lite_upload'+e+'" style="position: absolute; height: 100%; width: 100%; z-index: 10000; cursor: pointer;"></div><button class="flat_button button_big button_big_width">'+n.lang.button_browse+"</button></div>":t.innerHTML='<button id="uploader'+e+'" class="flat_button upload_btn '+(n.buttonClass||"")+'" style="position: relative;"><div id="lite_upload'+e+'" style="position: absolute; height: 100%; width: 100%; z-index: 10000; cursor: pointer;"></div>'+n.lang.button_browse+"</button>"),renderFlash(ge("lite_upload"+e),a,l,u),browser.msie&&setStyle(ge("lite_upload"+e),{opacity:0,cursor:"pointer"}),n.lang.switch_mode){var c=n.lang.switch_mode.replace("{link}",'<a onclick="Upload.switchMode('+e+');">');c=c.replace("{/link}","</a>"),t.appendChild(ce("div",{innerHTML:c,align:"left",className:"upload_switch_mode"},{marginTop:"15px"}))}},initForm:function(e,t){var o=e,i=this.vars[o],n=this.options[o];this.types[o]="form";var a='<form action="'+this.uploadUrls[o]+'" enctype="multipart/form-data" method="post" id="file_uploader_form'+o+'" target="upload_iframe'+o+'" style="text-align: center; width: 100%;">';if(n.signed)extend(i,{_jsonp:l.reg((function(e){s.onUploadComplete(o,e)}))});else{var r=s.onUploadComplete.pbind(o),d=s.onUploadError.pbind(o);this.callbacks["ondone"+o]=function(){var e=r.pbind.apply(r,arguments);setTimeout((function(){e()}),1)},this.callbacks["onfail"+o]=function(){var e=d.pbind.apply(d,arguments);setTimeout((function(){e()}),1)},extend(i,{al:1,ondone:"Upload.callbacks.ondone"+o,onfail:"Upload.callbacks.onfail"+o})}for(var p in i)i.hasOwnProperty(p)&&(a+='<input type="hidden" name="'+p+'" value="'+i[p]+'" />');var u='<input type="file" class="file" size="28" onchange="'+(n.uploadButton?"Upload.onUploadFileSelected("+o+")":"Upload.onUploadStart("+o+");")+'" name="'+n.file_name+'" style="cursor: pointer;"'+(n.accept?' accept="'+n.accept+'"':"")+'/></form><iframe style="position: absolute; visibility: hidden; width: 1px; height: 1px;" id="upload_iframe'+o+'" name="upload_iframe'+o+'"></iframe>';n.label?a+=n.label.split("{file}").join(u):a+=u,t.innerHTML=a;var c=n.file_input,h=geByClass1("file",t,"input");delete n.file_input,c&&h&&(h.parentNode.replaceChild(c,h),c.onchange=function(){s.onUploadStart(o)},window.data(c,"changed")&&(window.data(c,"changed",!1),c.onchange())),n.uploadButton&&n.setUploadAction?n.setUploadAction(e,(function(){s.onUploadStart(o)})):n.uploadButton&&!0!==n.uploadButton&&(ge(n.uploadButton).onclick=function(){s.onUploadStart(o)})},buttonOver:function(e){var t=s.options[e];t.flash_lite?t.hoverEl?addClass(t.hoverEl,"hover"):isVisible("photos_flash_add_button")?addClass(ge("photos_flash_add_button"),"hover"):addClass(ge("photos_upload_area"),"hover"):addClass(ge("lite_upload"+e).nextSibling,"hover")},buttonOut:function(e){var t=s.options[e];t.flash_lite?t.hoverEl?removeClass(t.hoverEl,"hover"):isVisible("photos_flash_add_button")?(removeClass(ge("photos_flash_add_button"),"hover"),removeClass(ge("photos_flash_add_button"),"active")):removeClass(ge("photos_upload_area"),"hover"):(removeClass(ge("lite_upload"+e).nextSibling,"hover"),removeClass(ge("lite_upload"+e).nextSibling,"active"))},buttonDown:function(e){s.options[e].flash_lite?isVisible("photos_flash_add_button")&&addClass(ge("photos_flash_add_button"),"active"):addClass(ge("lite_upload"+e).nextSibling,"active")},buttonUp:function(e){s.options[e].flash_lite?isVisible("photos_flash_add_button")&&removeClass(ge("photos_flash_add_button"),"active"):removeClass(ge("lite_upload"+e).nextSibling,"active")},initFileApi:function(e,t,o){var i,n=this.options[e],a=n&&n.dragEl||window.boxLayerWrap;o&&a&&(s.addedDocEvent||(addEvent(document,"drop",s.drop),s.addedDocEvent=!0),n.dragEvObj=a,addEvent(a,"dragenter",s.dragEnter.pbind(e)),addEvent(a,"dragover",s.dragOver.pbind(e)),addEvent(a,"dragleave",s.dragOut.pbind(e))),this.types[e]="fileApi",n.chooseBox?i='<input class="file" type="file" size="28" onchange="Upload.onFileApiSend('+e+', this.files);"'+(n.multiple?' multiple="true"':"")+(n.accept?' accept="'+n.accept+'"':"")+' name="'+n.file_name+'" style="cursor: pointer;"/>':n.uploadButton?(n.lang.button_browse||(n.lang.button_browse="Выбрать файл"),i='<button class="flat_button upload_btn fl_l '+(n.buttonClass||"")+'" onclick="this.nextSibling.nextSibling.click()">'+n.lang.button_browse+'</button><div class="upload_selected fl_l" style="padding: 4px 0 0 10px;"></div><input class="file" type="file" size="28" onchange="geByClass1(\'upload_selected\', this.parentNode).innerHTML = Upload.getFilesNames('+e+", this.files); Upload.onUploadFileSelected("+e+')"'+(n.multiple?' multiple="true"':"")+(n.accept?' accept="'+n.accept+'"':"")+' name="'+n.file_name+'" style="visibility: hidden; position: absolute;"/><br class="clear" />'):(n.lang.button_browse||(n.lang.button_browse="Выбрать файл"),i=n.flat_button?'<button class="upload_btn flat_button button_big_width button_big '+(n.buttonClass||"")+'" onclick="this.nextSibling.click()">'+n.lang.button_browse+'</button><input class="file" type="file" size="28" onchange="Upload.onFileApiSend('+e+', this.files);"'+(n.multiple?' multiple="true"':"")+(n.accept?' accept="'+n.accept+'"':"")+' name="'+n.file_name+'" style="visibility: hidden; position: absolute;"/>':'<button class="flat_button upload_btn '+(n.buttonClass||"")+'" onclick="this.nextSibling.click()">'+n.lang.button_browse+'</button><input class="file" type="file" size="28" onchange="Upload.onFileApiSend('+e+', this.files);"'+(n.multiple?' multiple="true"':"")+(n.accept?' accept="'+n.accept+'"':"")+' name="'+n.file_name+'" style="visibility: hidden; position: absolute;"/>'),n.label?t.innerHTML=n.label.split("{file}").join(i):t.innerHTML=i;var l=n.file_input,r=geByClass1("file",t,"input");l&&r&&(r.parentNode.replaceChild(l,r),l.onchange=function(){s.onFileApiSend(e,this.files)},window.data(l,"changed")&&(window.data(l,"changed",!1),setTimeout(l.onchange.bind(l),0))),n.uploadButton&&n.setUploadAction?n.setUploadAction(e,(function(){s.onFileApiSend(e,geByTag1("input",t).files)})):n.uploadButton&&!0!==n.uploadButton&&(ge(n.uploadButton).onclick=function(){s.onFileApiSend(e,geByTag1("input",t).files)})},switchMode:function(e){s.options[e].noFlash=s.options[e].noCheck=1,s.embed(e)},onUploadFileSelected:function(e){s.options[e].onUploadFileSelected&&s.options[e].onUploadFileSelected()},onUploadStart:function(e,t){cur.fileApiUploadStarted=!0;var o=void 0!==e.ind?e.ind:e;"form"==s.types[o]&&(ge("file_uploader_form"+o).submit(),geByClass1("file",s.obj[o]).disabled=!0);var i=s.options[o];i.onUploadStart&&i.onUploadStart(e,t)},getErrorAdditional:function(e){return e.error&&void 0!==e.server&&void 0!==e.bwact?(-1!==e.error.indexOf(":")?",":":")+" from upl_"+intval(e.server)+"?act="+e.bwact.replace(/[^a-zA-Z_0-9]/g,""):""},onUploadComplete:function(e,t,o){var i,n=void 0!==e.ind?e.ind:e,a=s.options[n];(void 0!==o&&n===e&&(e=o),"object"==typeof e&&(e.ind=n),"form"==s.types[n])&&(geByClass1("file",s.obj[n]).disabled=!1);if(a.onUploadComplete){var l="";a.signed&&((i=t?parseJSON(t):"")?l=s.getErrorAdditional(i):t='{"error":"ERR_CLIENT_UPLOAD_FAIL: upload request bad result, url \\"'+s.uploadUrls[n]+'\\""}'),a.onUploadComplete(e,t,l)}"form"==s.types[n]&&s.onUploadCompleteAll(e,t),"video"===a.type?statlogsValueEvent("upload_video_fails",1,a.server,"success"):"photo"===a.type?statlogsValueEvent("upload_photo_fails",1,a.server,"success"):"doc"===a.type&&statlogsValueEvent("upload_doc_fails",1,a.server,"success")},onUploadCompleteAll:function(e,t,o){var i=void 0!==e.ind?e.ind:e,n=s.options[i];if(void 0!==o&&i===e&&(e=o),"fileApi"===s.types[i]){var a=geByClass1("file",s.obj[i],"input");a&&(a.value="")}var l={duration:Date.now()-n.uploadStartedTs,type:n.type,total_size:n.filesTotalSize};"subtitles"!==n.type&&this.sendUploadStat(i,l),n.onUploadCompleteAll&&n.onUploadCompleteAll(e,t)},onUploadError:function(e,t){var o=void 0!==e.ind?e.ind:e,i=s.options[o];"form"===s.types[o]&&(geByClass1("file",s.obj[o]).disabled=!1);i.signed?i.onUploadComplete&&i.onUploadComplete(e,'{"error":"ERR_CLIENT_UPLOAD_FAIL: upload request fail, code \\"'+t.replace(/([\\\"])/g,"\\$1").replace(/\n/g,"\\n")+'\\", url \\"'+s.uploadUrls[o]+'\\""}'):i.onUploadError&&i.onUploadError(e,t)},onConnectionLost:function(e){var t=void 0!==e.ind?e.ind:e,o=s.options[t];o.onConnectionLost&&o.onConnectionLost(e)},onUploadProgress:function(e,t,o){var i=void 0!==e.ind?e.ind:e,n=s.options[i];n.onUploadProgress&&n.onUploadProgress(e,t,o)},onDebug:function(e,t){var o=void 0!==e.ind?e.ind:e,i=s.options[o];i.onDebug&&i.onDebug(e,t)},onSelectClick:function(e,t){var o=void 0!==e.ind?e.ind:e,i=s.options[o];i.onSelectClick&&i.onSelectClick(e,t)},getFilesNames:function(e,t){if(t&&t.length){var o=this.options[e];return o.multiple?(o.lang.selected_num_files||(o.lang.selected_num_files=["","%s файл","%s файла","%s файлов"]),langNumeric(t.length,o.lang.selected_num_files)):t[0].name.replace(/[&<>"']/g,"")}},checkFileType:function(e,t,o){var i=!1;if(o&&""!==o){var n=!0;if(each(o.split(";"),(function(t,o){if(o=o.substr(1).toLowerCase(),e.substr(-o.length).toLowerCase()==o)return n=!1,!1})),!n)return!1}return each(t.split(";"),(function(t,o){if(o=o.substr(1).toLowerCase(),e.substr(-o.length).toLowerCase()==o||".*"==o)return i=!0,!1})),i},checkFilesSizes:function(e,t){var o=this.options[e];if(o.file_size_limit)for(var n in t)if(t.hasOwnProperty(n)){var a=t[n];if(a.size&&a.size>o.file_size_limit){var l=o.lang.filesize_error;return l&&l.indexOf("{count}")>=0&&(l=l.replace("{count}",intval(o.file_size_limit/1048576))),l&&Object(i.showFastBox)({title:getLang("global_error"),width:430,dark:1,bodyStyle:"padding: 20px; line-height: 160%;",onHide:function(){s.embed(e),delete cur.notStarted}},l,getLang("global_cancel")),!1}}return!0},onFileApiSend:function(e,t,o){if(t&&t.length){var n=this.options[e];if(n.file_types){var a=[];if(each(t,(function(e,t){s.checkFileType(t.name,n.file_types,n.file_disallowed_types)&&a.push(t)})),!a.length)return void(n.onNoFilteredCallback&&n.onNoFilteredCallback(t));t=a}if((!n.filterCallback||(t=n.filterCallback(e,t)).length)&&(n.reverse_files&&(t=Array.prototype.slice.call(t).reverse()),!n.multiple&&t.length>1&&(t=[t[0]]),this.checkFilesSizes(e,t))){if(n.photoBox&&!o)return s.onPhotoAdd(e,t);if(!n.withoutAutoUpload||o){n.beforeUpload&&n.beforeUpload(e),cur.notStarted=cur.fileApiUploadStarted=!0,n.multi_progress||this.onUploadStart({ind:e,fileName:(t[0].fileName||t[0].name||"").replace(/[&<>"']/g,"")});var l=t.length;if(n.max_files){var r=cur.attachCount;if(!r&&cur.addMedia){var d=-1;for(var p in cur.addMedia)p>d&&(d=p);d>=0&&cur.addMedia[d]&&cur.addMedia[d].attachCount&&(r=cur.addMedia[d].attachCount)}var u=r?r():0,c=(n.max_files_warning||getLang("global_attach_max_n_files",n.max_files)).replace("{count}",n.max_files);n.max_files-u<t.length?(l=n.max_files-u,Object(i.showFastBox)({title:getLang("global_error"),width:430,dark:1,bodyStyle:"padding: 20px; line-height: 160%;",onHide:function(){s.embed(e),delete cur.notStarted,n.onMaxCount&&n.onMaxCount()}},c,getLang("global_continue"),(function(){s.uploadFiles(e,t,l),n.max_files_hide_last?curBox().hide():boxQueue.hideAll()}),getLang("global_cancel"))):(n.force_max_files&&(l=Math.min(l,n.max_files-(cur.savedPhotos||[]).length)),this.uploadFiles(e,t,l))}else this.uploadFiles(e,t,l)}else n.onFilesSelected&&n.onFilesSelected(e,t)}}},onPhotoAdd:function(e,t){var o=0,i=0;s.fileList=s.fileList||{},s.fileList[e]||(s.fileList[e]=[],s.options[e].onPhotoBox&&(o=!0)),each(t,(function(t,o){i++;var n=s.options[e].photoBox,a=new RegExp("image.*");o.type.match(a),cur.uploaderPhotoId=(cur.uploaderPhotoId||0)+1;var l=cur.uploaderPhotoId;s.fileList[e][l]=o;var r=ce("img"),d=ce("div",{id:"photos_add_item"+l,className:"photos_add_item",innerHTML:'<span class="photos_add_img photos_add_wait" id="photos_add_cont'+l+'" onmouseover="PhotosAdd.thumbOver('+l+', this);" onmouseout="PhotosAdd.thumbOut('+l+');"><span class="photos_add_s" id="photos_add_s'+l+'">&nbsp;</span></span><span class="bg">&nbsp;</span>'});n.appendChild(d);var p=new FileReader;p.onload=function(e){r.src=e.target.result,r.onload=function(){r.onload=!1;var e,t,o={w:r.width,h:r.height};o.w>130&&(e=130/o.w,o.w=130,o.h=parseInt(o.h*e)),o.h>130&&(t=130/o.h,o.h=130,o.w=parseInt(o.w*t));var i=ce("canvas",{width:o.w,height:o.h});i.getContext("2d").drawImage(r,0,0,o.w,o.h);var n=i.toDataURL("image/jpeg");r.src=n;var a=ge("photos_add_s"+l),d=Math.max(o.w,80),p=Math.min(o.h,98);setStyle(a,{width:d,height:p,marginLeft:Math.ceil((130-d)/2)}),a.innerHTML="",a.appendChild(r),r.onload=function(){setTimeout((function(){a.parentNode.className="photos_add_img"}),0),r.onload=!1},s.finishTask()}},s.taskToQ((function(){p.readAsDataURL(o)}))})),o&&i&&s.options[e].onPhotoBox(),s.options[e].onPhotoAdd&&i&&s.options[e].onPhotoAdd()},uploadPhotos:function(e){var t=[],o=s.fileList[e];for(var i in o)o[i]&&t.push(extend(o[i],{fileRef:i}));return s.options[e].onUploadStart&&s.options[e].onUploadStart(),!!t.length&&(cur.uploadCount=Math.min(500,t.length),s.uploadFiles(e,t,cur.uploadCount),!0)},taskToQ:function(e){if(s.previewFileQ||(s.previewFileQ=[]),e&&s.previewFileQ.push(e),!s.doingQ){var t=s.previewFileQ.shift();t&&(s.doingQ=!0,t())}},finishTask:function(){setTimeout((function(){s.doingQ=!1,s.taskToQ()}),100)},uploadFiles:function(e,t,o){if(!(o<=0)){var i,n=this.options[e],a=n.signed?this.vars[e]:extend(this.vars[e],{ajx:1}),l=0,r=0,d=0,p=0,u=[];n.uploading&&(l=n.filesTotalSize||0,r=n.filesTotalCount||0,p=n.filesLoadedCount||0,d=n.filesLoadedSize||0,u=n.filesQueue),n.file_match&&(i=new RegExp(n.file_match,"i"));for(var c=!1,h=0;h<o;h++){var f=(t[h].fileName||t[h].name||"").replace(/[&<>"']/g,"");!n.file_match||f.match(i)?(n.multi_progress&&!n.multi_sequence&&this.onUploadStart({ind:e,fileName:f}),l+=t[h].size,r+=1,u.push(t[h])):c=!0}if(u.reverse(),extend(n,{filesQueue:u,filesTotalSize:l,filesLoadedSize:d,filesLoadedCount:p,filesTotalCount:r,uploadStartedTs:Date.now()}),u.length>0)if(void 0!==cur.multiProgressIndex)cur.nextQueues||(cur.nextQueues=[]),cur.nextQueues.push(e);else{var g=AjaxConvert.toQueryString(a),m=this.uploadUrls[e]?this.uploadUrls[e]+(this.uploadUrls[e].match(/\?/)?"&":"?")+g:"";this.uploadFile(e,u.pop(),m),n.multi_progress&&(cur.multiProgressIndex=e)}else c&&s.onUploadError(e,"file type not supported")}},getFileInfo:function(e,t,o){return t.multi_progress?{ind:e,fileName:o?(o.fileName||o.name||"").replace(/[&<>"']/g,""):"",num:t.filesLoadedCount,totalSize:t.filesTotalSize,loadedSize:t.filesLoadedSize,totalCount:t.filesTotalCount,file:o}:e},supportsChunkedUpload:function(){return!!Blob&&!!(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)&&!!FileReader},uploadFileChunked:function(e,t,o){var i=this.options[e],n=s.getFileInfo(e,i,t);i.multi_sequence&&this.onUploadStart(n);var a={file:t,fileName:(t.name||t.fileName).replace(/[&<>"']/g,""),fileSize:t.size,fileMime:t.type,retryCount:0,timeouts:[],activeRequests:[],requestsProgress:{},pointer:0,state:{url:o,started:Date.now(),loaded:null,chunkSize:i.chunkSize||4194304,sessionId:(1e17*Math.random()).toString(16)}};function l(){for(a.pointer=0,a.chunksLeft=a.chunksNum;a.activeRequests.length<4&&a.pointer<a.fileSize;)r()}function r(){var u=a.pointer,c=Math.min(u+a.state.chunkSize,a.fileSize)-1;if(!(u>=a.fileSize)){var h=!1;a.state.loaded&&each(a.state.loaded.split(","),(function(e,t){var o=t.match(/^(\d+)-(\d+)\/\d+$/),i=parseInt(o[1]),n=parseInt(o[2]);if(u>=i&&c<=n)return h=!0,a.chunksLeft-=Math.ceil((n+1-u)/a.state.chunkSize),a.pointer=n+1,!1})),h?(d(),r()):(!function u(c,h){var f=(t.slice||t.webkitSlice||t.mozSlice).call(t,c,h+1),g=new XMLHttpRequest;g.open("POST",o,!0),g.upload.onprogress=function(e){g.readyState!==XMLHttpRequest.DONE&&(e.lengthComputable&&(a.requestsProgress[c]=e.loaded),d())},g.onload=function(u){var f;a.activeRequests.splice(indexOf(a.activeRequests,u.target),1),a.retryCount=0,--a.chunksLeft,201==u.target.status?(a.chunksLeft?(a.state.loaded=u.target.responseText,ls.set(a.storageKey,a.state),r()):(a.state.loaded=u.target.responseText,ls.set(a.storageKey,a.state),l()),delete a.requestsProgress[c],d()):200!=u.target.status||a.chunksLeft?(ls.remove(a.storageKey),a.abort(),s.onUploadError(n),s.options[e].filesQueue.length||(s.startNextQueue(e),s.onUploadCompleteAll(n,u.target.responseText),i.uploading=!1),p(u.target.status,u.target.responseText,c+"-"+h)):(ls.remove(a.storageKey),f=u.target.responseText,extend(n,s.getFileInfo(e,i,t)),s.options[e].filesLoadedSize+=a.fileSize,s.options[e].filesLoadedCount+=1,s.onUploadComplete(n,f),s.options[e].filesQueue&&s.options[e].filesQueue.length>0?s.uploadFile(e,s.options[e].filesQueue.pop(),o):(s.startNextQueue(e),s.onUploadCompleteAll(n,f),i.uploading=!1))},g.onerror=function(e){if(a.activeRequests.splice(indexOf(a.activeRequests,e.target),1),++a.retryCount<=50){var t=setTimeout(u.bind(null,c,h),300*a.retryCount);a.timeouts.push(t)}else a.abort(),s.onConnectionLost(n);d(),p(e.target.status,e.target.responseText,c+"-"+h)},g.setRequestHeader("Content-Disposition",'attachment, filename="'+encodeURI(a.fileName)+'"'),g.setRequestHeader("Content-Type",a.fileMime||"application/octet-stream"),g.setRequestHeader("Content-Range","bytes "+c+"-"+h+"/"+a.fileSize),g.setRequestHeader("Session-ID",a.state.sessionId),g.send(f),f=null,a.activeRequests.push(g)}(u,c),a.pointer+=a.state.chunkSize)}}function d(){var o=a.fileSize,l=(a.chunksNum-a.chunksLeft)*a.state.chunkSize;each(a.requestsProgress,(function(e,t){l+=t})),extend(n,s.getFileInfo(e,i,t)),i.multi_progress?s.onUploadProgress(n,l,o):s.onUploadProgress(e,Math.min(l+i.filesLoadedSize,i.filesTotalSize),i.filesTotalSize)}function p(e,t,i){ajax.post("al_video.php",{act:"uploadVideoFailStat",url:o,error:e+","+t,range:i,sessionId:a.state.sessionId,chunksLeft:a.chunksLeft,loaded:a.state.loaded})}a.abort=function(e){each(e.timeouts,(function(e,t){clearTimeout(t)})),each(e.activeRequests,(function(e,t){t.abort()})),e.timeouts=[],e.activeRequests=[]}.bind(null,a),a.chunksNum=Math.ceil(a.fileSize/a.state.chunkSize),a.chunksLeft=a.chunksNum,function(e,t){var o=Math.floor(e.size/2)-524288,i=[e.slice(0,1048576),e.slice(o,o+1048576),e.slice(e.size-1048576,e.size)];!function e(o){var n=i.shift();if(n){var a=new FileReader;a.addEventListener("loadend",(function(t){var i,n,a=new Uint8Array(t.target.result),l=(i=65535,n=65535,{append:function(e){for(var t=e.length,o=0;t;){var a=t>359?359:t;t-=a;do{n+=i+=e[o++]}while(--a);i=((65535&i)>>>0)+(i>>>16),n=((65535&n)>>>0)+(n>>>16)}},result:function(){return((n=((65535&n)>>>0)+(n>>>16))<<16>>>0|(i=((65535&i)>>>0)+(i>>>16)))>>>0}});l.append(a),o+=l.result().toString(16),e(o)})),a.readAsArrayBuffer(n)}else t(o)}("")}(t,(function(e){a.storageKey=["upload",e,a.fileSize].join("_"),i.uploading=!0,i.chunkedUpload=a;var t=ls.get(a.storageKey);t&&(Date.now()-t.started<864e5?(a.state=t,o=t.url):ls.remove(a.storageKey));try{console.log("%c Warning: if devtools is logging network requests it may cause high memory usage during file upload","font-size:16px;color:orange;")}catch(e){}l()}))},resumeUpload:function(e){var t=this.options[e].chunkedUpload;s.uploadFileChunked(e,t.file,t.state.url)},isNeedRequestUrl:function(e){var t=this.options[e];return t.requestOptionsForFile&&"video"===t.type},getUploadOptions:function(e,t){var o=this.options[e],i=cur.gid||0;inArray(cur.module,["public","groups","ads"])&&"post"===o.from&&(i=-cur.oid),s.options[e].uploadOptionsXhr=ajax.post("al_video.php?act=get_upload_params",{gid:i,from:o.from},{onDone:function(o){var i=AjaxConvert.toQueryString(o.vars),n=o.options.url+(o.options.url.match(/\?/)?"&":"?")+i;extend(s.options[e],o.options),extend(s.vars[e],o.vars),s.uploadUrls[e]=n,s.check(e),s.uploadFile(e,t,n,!0)},onFail:function(){s.terminateUpload(e,t.name)}})},uploadFile:function(e,t,o,i){var n=this.options[e];if(!s.isNeedRequestUrl(e)||i)if(n.chunked&&s.supportsChunkedUpload()&&t.size>4194304)s.uploadFileChunked.apply(s,arguments);else{var l=browser.msie&&intval(browser.version)<10?window.XDomainRequest:window.XMLHttpRequest,r=s.getFileInfo(e,n,t);n.multi_sequence&&this.onUploadStart(r),n.uploading=!0;var d=null;if(window.FormData){var p=new FormData;t instanceof File?p.append(n.file_name,t):p.append(n.file_name,t,t.filename.replace(/[&<>"']/g,"")),d=new l;d.open("POST",o,!0),d.onload=function(i){extend(r,s.getFileInfo(e,n,t)),s.options[e].filesLoadedSize+=t.size,s.options[e].filesLoadedCount+=1,s.onUploadComplete(r,i.target.responseText),s.options[e].filesQueue&&s.options[e].filesQueue.length>0?s.uploadFile(e,s.options[e].filesQueue.pop(),o):(s.startNextQueue(e),s.onUploadCompleteAll(r,i.target.responseText),n.uploading=!1)},d.onerror=function(i){extend(r,s.getFileInfo(e,n,t)),s.options[e].filesTotalSize-=t.size,s.options[e].filesTotalCount-=1,s.onUploadError(r,i.target.responseText),s.options[e].filesQueue.length>0?s.uploadFile(e,s.options[e].filesQueue.pop(),o):(s.startNextQueue(e),s.onUploadCompleteAll(r,i.target.responseText),n.uploading=!1)},d.upload.onprogress=function(o){d.readyState!==XMLHttpRequest.DONE&&(!1,extend(r,s.getFileInfo(e,n,t)),o.lengthComputable&&(n.multi_progress?s.onUploadProgress(r,o.loaded,o.total):s.onUploadProgress(e,Math.min(o.loaded+n.filesLoadedSize,n.filesTotalSize),n.filesTotalSize)))},d.send(p)}else{Object(a.saveStatlogEvents)({name:"upload_tmp_stat",value:1,keys:["window_formdata_not_exists"]});try{if(l&&!l.prototype.sendAsBinary&&window.ArrayBuffer&&window.Uint8Array){var u=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;u&&(l.prototype.sendAsBinary=function(e){for(var t=new window.ArrayBuffer(e.length),o=new Uint8Array(t,0),i=0;i<e.length;i++)o[i]=255&e.charCodeAt(i);var n=new u;n.append(t);var a=n.getBlob();this.send(a)})}var c=new FileReader;c.onload=function(){(d=new l).onload=function(i){extend(r,s.getFileInfo(e,n,t)),s.options[e].filesLoadedSize+=t.size,s.options[e].filesLoadedCount+=1,s.onUploadComplete(r,i.target.responseText),s.options[e].filesQueue.length>0?s.uploadFile(e,s.options[e].filesQueue.pop(),o):(s.startNextQueue(e),s.onUploadCompleteAll(r,i.target.responseText))},d.onerror=function(i){extend(r,s.getFileInfo(e,n,t)),s.options[e].filesTotalSize-=t.size,s.options[e].filesTotalCount-=1,s.onUploadError(r,i.target.responseText),s.options[e].filesQueue.length>0?s.uploadFile(e,s.options[e].filesQueue.pop(),o):(s.startNextQueue(e),s.onUploadCompleteAll(r,i.target.responseText),n.uploading=!1)},d.upload.onprogress=function(o){extend(r,s.getFileInfo(e,n,t)),o.lengthComputable&&(n.multi_progress?(s.onUploadProgress(r,o.loaded,o.total),n.uploading=!1):s.onUploadProgress(e,Math.min(o.loaded+n.filesLoadedSize,n.filesTotalSize),n.filesTotalSize))},d.open("POST",o,!0);var i="---------"+irand(1111111111,9999999999);d.setRequestHeader("Content-Type","multipart/form-data, boundary="+i);var a="--"+i+"\r\n";a+="Content-Disposition: form-data; name='"+n.file_name+"'; filename='"+t.name.replace(/[&<>"']/g,"")+"'\r\n",a+="Content-Type: application/octet-stream\r\n\r\n",a+=c.result+"\r\n",a+="--"+i+"--",d.sendAsBinary(a)},c.readAsBinaryString(t)}catch(e){try{console.error(e)}catch(e){}}}s.options[e].xhr=d}else s.getUploadOptions(e,t)},terminateUpload:function(e,t,o){try{var i=s.vars[e],n=s.options[e],a=AjaxConvert.toQueryString(i),l=n.filesQueue,r=!1,d=n.multi_progress?{ind:e,fileName:t.replace(/[&<>"']/g,"")}:e,p=t?e+"_"+t:e;for(var u in l)if(t==(l[u].fileName||l[u].name||"").replace(/[&<>"']/g,"")){l.splice(u,1),r=!0;break}o&&o.tt&&o.tt.destroy&&o.tt.destroy(),re("upload"+p+"_progress_wrap"),s.onUploadComplete(d,'{"error":"ERR_UPLOAD_TERMINATED: upload request was terminated"}'),!r&&n.xhr&&n.xhr.abort(),!r&&n.chunkedUpload&&n.chunkedUpload.abort();var c=this.uploadUrls[e]+(this.uploadUrls[e].match(/\?/)?"&":"?")+a;r||(l.length>0?s.uploadFile(e,l.pop(),c):(s.startNextQueue(e),s.onUploadCompleteAll(d,"")))}catch(e){try{console.error(e)}catch(e){}}},terminateAllUploads:function(){this.checked&&each(this.checked,(function(e){if(e=+e,s.isSomethingUploading(e)){var t=s.options[e];if(t){var o="";t.filesQueue&&t.filesQueue.length&&(t.filesQueue=[]),t.xhr&&4!==t.xhr.readyState&&0!==t.xhr.readyState&&(o=t.file_name),t.chunked&&t.chunkedUpload&&t.chunkedUpload.activeRequests.length&&(o=t.chunkedUpload.fileName,this.terminateUpload(e,o)),o&&this.terminateUpload(e,o)}}}))},startNextQueue:function(e){if(void 0===cur.multiProgressIndex&&setTimeout((function(){delete cur.fileApiUploadStarted}),1e3),e==cur.multiProgressIndex)if(this.options[e].multi_progress&&cur.nextQueues&&cur.nextQueues.length){var t=cur.nextQueues[0],o=s.options[t].filesQueue;for(cur.nextQueues.splice(0,1);0==o.length&&cur.nextQueues.length>0;)t=cur.nextQueues[0],cur.nextQueues.splice(0,1),o=s.options[t].filesQueue;if(o.length>0){var i=s.vars[t],n=AjaxConvert.toQueryString(i),a=s.uploadUrls[t]+(s.uploadUrls[t].match(/\?/)?"&":"?")+n;s.uploadFile(t,o.pop(),a),cur.multiProgressIndex=t}else delete cur.multiProgressIndex,setTimeout((function(){delete cur.fileApiUploadStarted}),1e3)}else delete cur.multiProgressIndex,setTimeout((function(){delete cur.fileApiUploadStarted}),1e3)},isFileDrag:function(e){if(!e||e.target&&("IMG"==e.target.tagName||"A"==e.target.tagName))return!1;if(!e.dataTransfer.types)return!0;for(var t=0;t<e.dataTransfer.types.length;t++)if("Files"==e.dataTransfer.types[t])return!0;return!1},dragEnter:function(e,t){cur.uploadDragStarted&&1!=cur.uploadDragStarted||(cur.uploadDragStarted=s.isFileDrag(t)?2:1),1!=cur.uploadDragStarted&&s.dropbox[e]?(setTimeout((function(){clearTimeout(s.dragTimer[e]),delete s.dragTimer[e]}),0),s.options[e].onDragEnter&&s.options[e].onDragEnter(t),show(s.dropbox[e]),cancelEvent(t)):cancelEvent(t)},dragOut:function(e,t){1!=cur.uploadDragStarted&&s.dropbox[e]?(s.dragTimer[e]&&(clearTimeout(s.dragTimer[e]),delete s.dragTimer[e]),s.dragTimer[e]=setTimeout((function(){s.options[e].visibleDropbox||hide(s.dropbox[e]),s.options[e].onDragOut&&s.options[e].onDragOut(),removeClass(s.dropbox[e],"dropbox_over")}),100),cancelEvent(t)):cancelEvent(t)},dragOver:function(e,t){if(1!=cur.uploadDragStarted&&s.dropbox[e]){var o=s.insideDropbox(e,t);t.dataTransfer&&"copy"!==t.dataTransfer.dropEffect&&(t.dataTransfer.dropEffect=o?"copy":"none"),toggleClass(s.dropbox[e],"dropbox_over",o),cancelEvent(t)}else cancelEvent(t)},drop:function(e){return each(s.dropbox,(function(t,o){o&&(s.insideDropbox(t,e)&&s.onFileApiSend(t,e.dataTransfer.files),s.options[t].visibleDropbox||hide(o),s.options[t].onDrop&&s.options[t].onDrop(),removeClass(o,"dropbox_over"))})),delete cur.uploadDragStarted,cancelEvent(e),!1},insideDropbox:function(e,t){for(var o=t.target;o.parentNode;){if(o==s.dropbox[e])return!0;o=o.parentNode}return!1},isSomethingUploading:function(e){var t=s.options[e];return!!t&&(!(!t.filesQueue||!t.filesQueue.length)||(!(!t.xhr||4===t.xhr.readyState||0===t.xhr.readyState)||(!(!t.uploadOptionsXhr||4===t.uploadOptionsXhr.readyState||0===t.uploadOptionsXhr.readyState)||!!(t.chunked&&t.chunkedUpload&&t.chunkedUpload.activeRequests.length))))},flashCallbacks:function(){return{onUploadStart:s.onUploadStart,onUploadProgress:s.onUploadProgress,onUploadSuccess:s.onUploadComplete,onUploadComplete:s.onUploadCompleteAll,onUploadError:s.onUploadError,onDebug:s.onDebug,onMouseDown:s.buttonDown,onMouseUp:s.buttonUp,onMouseOver:s.buttonOver,onMouseOut:s.buttonOut,onSelectClick:s.onSelectClick}},sendUploadStat:function(e,t){var o=s.options[e],i=s.vars[e];if(!o.signed&&o.error_hash){var n=extend({act:"stat",mid:i.mid,oid:i.oid,gid:i.gid,aid:i.aid,server:o.server,error:o.error,hash:o.error_hash},t);ajax.post("upload_fails.php",n)}}};window.jsonpManager||(window.jsonpManager=l),window.Upload||(window.Upload=s);try{window.stManager.done(window.jsc("web/upload.js"))}catch(e){}}});