(window.webpackJsonp=window.webpackJsonp||[]).push([["bundles/92d561a0bfe326994ae42c79e0aa3e55"],{Nk8j:function(e,t,s){"use strict";function i(e){var t=cur.pvListId,s=cur.pvIndex;if(cur.pvData&&t&&!isNaN(s)){var i=cur.pvData[t][s];return e?i[e]:i}return!1}function o(e,t){var s=cur.pvListId,i=cur.pvIndex;return!(!cur.pvData||!s||isNaN(i))&&(cur.pvData[s][i][e]=t,cur.pvData[s][i])}function n(){return cur.pvIndexedFriends}function r(e,t){cur.pvIndexedFriends=new vkIndexer(e,e=>e[1],t)}s.r(t),s.d(t,"getPhotoData",(function(){return i})),s.d(t,"setPhotoData",(function(){return o})),s.d(t,"getIndexedFriends",(function(){return n})),s.d(t,"setIndexedFriends",(function(){return r}))},yTQ2:function(e,t,s){"use strict";s.r(t);s("pIFo"),s("HEwt"),s("rGqo"),s("rE2o"),s("ioFf"),s("OG14"),s("a1Th"),s("Btvt");var i=s("Nk8j");function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var s=[],i=!0,o=!1,n=void 0;try{for(var r,d=e[Symbol.iterator]();!(i=(r=d.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==d.return||d.return()}finally{if(o)throw n}}return s}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(s);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return n(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}var r="friends_dropdown__list_item",d="friends_dropdown__list_item system_message";var h=class{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=extend({onUserSelected:()=>!1,onEscapePress:()=>!1,onKeyUp:()=>!1},e),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new vkIndexer([],e=>{var t=o(e,2);t[0];return t[1]}),cur.pvServerFriendsIds=[]),this.topUsers=new vkIndexer([],e=>{var t=o(e,2);t[0];return t[1]}),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}init(){this.isInited&&this.friendsdListNode||(Object(i.getIndexedFriends)()||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll());return this.friendsdListNode}update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this._resetScroll(),this.setTopUsers(e),this._hideDropdown()}setTopUsers(e){this.topUsers.list.forEach(e=>{this.topUsers.remove(e)}),e.forEach(e=>{this.topUsers.add(e)}),this.topUsers.list=e}_hideDropdown(){removeClass(this.friendsdListNode,"show-dropdown")}_getItemHtml(e,t,s,i){return`<div class="${r}" data-id="${e}" data-name="${t}">\n      <img src="${i}" alt="${t}" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">${t} ${e===vk.id.toString()?`(${getLang("photos_tags_user_you")})`:""}</div>\n        <div class="friends_dropdown__list_label">${s}</div>\n      </div>\n    </div>`}_initElement(){this.friendsdListNode=ce("div",{className:"friends_dropdown__list"}),this.listInput=ce("input",{className:"friends_dropdown__list_input",placeholder:""+replaceEntities(getLang("photos_tags_dropdown_placeholder"))}),this.listDropdown=ce("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=ce("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML(`<div class="${d}">${getLang("box_loading")}</div>`),addEvent(this.friendsdListNode,"click",cancelEvent),addEvent(this.listDropdown,"click",e=>{this._handleItemSelected(e.target)}),addEvent(this.listDropdown,"mouseover",e=>{if(!this.keyboardNavigation){var t=hasClass(e.target,r)?e.target:gpeByClass(r,e.target);this._setHoverItem(t)}}),addEvent(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),addEvent(this.listInput,"click",()=>{this.show()})}_handleItemSelected(e){var t=hasClass(e,r)?e:gpeByClass(r,e),s=domData(t,"name"),i=domData(t,"id");i&&this.options.onUserSelected(i,s),hasClass(e,"add_term_tag")&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)}_getItemEleById(e){return window.domQuery1(`[data-id="${e}"]`,this.listDropdown)}_setListHTML(e){(this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent).innerHTML=e}_setHoverItem(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=domData(e,"id");if(s&&s!==this.hoverItem){if(this.hoverItem){var i=this._getItemEleById(this.hoverItem);removeClass(i,"hover")}this.hoverItem=s,addClass(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}}show(e){hasClass(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),addClass(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())}_renderFriendsList(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e=trim(e),Object(i.getIndexedFriends)()){var s=this._doSearch(e);this._renderFriendsDropdown(e,s,t)}else this._setListHTML(`<div class="${d}">${getLang("box_loading")}</div>`);clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout(()=>{this.fetchFriendsWithQuery(e)},300))}_initScroll(){browser.safari||stManager.add(["ui_common.css","ui_common.js"],()=>{this.scroll=new window.uiScroll(this.listContent,{global:!0})})}_handleInputKeyEvent(e){if("keyup"===e.type){switch(e.keyCode){case KEY.ENTER:this._handleEnter();break;case KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case KEY.UP:case KEY.DOWN:this._handleArrows(e.keyCode===KEY.DOWN)}}_handleArrows(){var e,t,s=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.keyboardNavigation||(this.keyboardNavigation=!0,addEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)e=this._getItemEleById(this.hoverItem),t=s?domNS(e):domPS(e);else{var i=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;t=domFC(i)}t&&this._setHoverItem(t,!0)}_handleMouseMoveOnce(){this.keyboardNavigation=!1,removeEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)}_handleEnter(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}}_doSearch(){var e,t,s,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",d=Object(i.getPhotoData)("tagged"),h=Object(i.getIndexedFriends)();r.length>0?(t=this.topUsers.search(r),s=h.search(r),n=cur.pvServerFriendsIndex.search(r)):(t=this.topUsers.list,s=h.list,n=cur.pvServerFriendsIndex.list),e=t.concat(s,n);var a=[];return(e=e.filter(e=>{var t=o(e,1)[0],s=a.indexOf(t)<0&&(!d||!d[t]);return a.push(t),s})).length>20&&(e=e.slice(0,20)),e}_renderFriendsDropdown(e,t){var s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i="";if(t.forEach(e=>{var t=o(e,4),s=t[0],n=t[1],r=t[2],d=t[3],h="id"+s;i+=this._getItemHtml(s,n,r,d,h)}),!i&&s){this.freeTerm=e,e=clean(e);var n=getLang("photos_tags_not_found_tag_text").replace("{tagName}",`<span class="add_term_tag">${e}</span>`);i=`<div class="${d}">${n}</div>`,this._setListHTML(i)}else i&&(this._setListHTML(i),this.freeTerm=null,this._resetScroll());this.hoverItem=null}focus(){this.listInput.focus()}reset(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()}_resetScroll(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0}fetchFriendsList(){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:e=>{Object(i.setIndexedFriends)(e,()=>{this._renderFriendsList(this.lastSeachTerm)})}})}fetchFriendsWithQuery(e){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:Object(i.getPhotoData)("id")},{onDone:t=>{this._handleFetchFriends(e,t)}})}_handleFetchFriends(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.lastSeachTerm===e){var s,n=0,r=Object(i.getPhotoData)("tagged");(s=r?t.filter(e=>{var t=o(e,1)[0];return!r[t]}):t).forEach(e=>{var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),n++)}),(n>0||0===s.length)&&this._renderFriendsList(e,!0)}}};t.default=class{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.options=extend({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:()=>!1,onMouseLeave:()=>!1,onEscapePressed:()=>!1,onDeleteClicked:()=>!1,onSuggestionDeclined:()=>!1},t),this.container=e,this.friendsDropdown=new h({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}renderTooltip(){this.tooltipNode=ce("div",{className:"photo_tooltip"},{display:"none"});var e=ce("div",{className:"photo_tooltip__content"});this.sugggestionNode=ce("div"),this.nameNode=ce("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=ce("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),addEvent(this.nameNode,"click",this._handleConfirmedTooltipClick),e.appendChild(this.nameNode),e.appendChild(this.sugggestionNode),e.appendChild(this.listNode),this.tooltipNode.appendChild(e),this.container.appendChild(this.tooltipNode),addEvent(this.tooltipNode,"mouseenter",()=>{this.isActive=!0}),addEvent(this.sugggestionNode,"click",e=>{switch(cancelEvent(e),window.domData(e.target,"button")){case"yes":this.options.onUserSelected(this.suggestedUserId,this.suggestedUserName,!0);break;case"no":this.options.onSuggestionDeclined(),hide(this.sugggestionNode),this.showFriendsList(),this.userHref=null,this.showAndFocusFriendsList()}}),addEvent(this.tooltipNode,"mouseleave",()=>{this.interaction||(this.isActive=!1,this.options.onMouseLeave())}),this.options.closeOnClick&&addEvent(document,"click",this._handleDocumentClick)}_handleDocumentClick(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()}_handleUserSelected(e,t){this.isActive=!1,this.options.onUserSelected(e,t)}_handleEscapePress(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()}_handleStartInteraction(){this.interaction=!0}_handleConfirmedTooltipClick(e){cancelEvent(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&this._go(this.userHref,e)}updatePosition(e){var t=e.top,s=e.right,i=e.bottom,o=e.left,n=s-o,r=getSize(this.tooltipNode),d=r[0]?r[0]:280,h="bottom",a=o+Math.floor(n/2)-d/2,l=i;if((a<10||this.hasDropdown&&i>window.clientHeight()-300)&&(h="right_top"),"right_top"===h){a=s,l=t;var c=window.clientHeight()-t;c<300&&(l=t-300+c)}domData(this.tooltipNode,"dir",h),setStyle(this.tooltipNode,{top:l,left:a})}updateSuggestionQuestion(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e}_getSuggestionHTML(e,t){var s=e===vk.id?getLang("photos_tags_user_you"):t;return`<div class="suggested_tag_user">\n      ${getLang("photos_tags_suggestion_question").replace("{userName}",`<div class="suggested_tag_user__name">&nbsp;${s}</div>`)}\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">${getLang("box_yes")}</button>\n        <span>&middot;</span>\n        <button data-button="no">${getLang("box_no")}</button>\n      </div>\n    </div>`}updateState(e){var t=e.suggestedUserName,s=e.suggestedUserId,i=e.usersList,o=e.userName,n=e.userHref,r=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=n,this.hasDropdown=!1,removeClass(this.tooltipNode,"tagged"),o?(this.nameNode.innerHTML=`${o} ${r?"<button>Delete</button>":""}`,toggleClass(this.nameNode,"show_delete",r),show(this.nameNode),hide(this.listNode),hide(this.sugggestionNode),addClass(this.tooltipNode,"tagged")):s?(this.updateSuggestionQuestion(s,t),hide(this.nameNode),hide(this.listNode),show(this.sugggestionNode)):(this.friendsDropdown.update(i),hide(this.nameNode),hide(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)}showFriendsList(){show(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()}resetFriendsDropdown(){this.friendsDropdown.reset()}show(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),show(this.tooltipNode),s&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}hide(){hide(this.tooltipNode)}showAndFocusFriendsList(e){this.userHref?this._go(this.userHref,e):(this.friendsDropdown.focus(),this.friendsDropdown.show())}unMount(){removeEvent(document,"click",this._handleDocumentClick),re(this.tooltipNode)}_go(e,t){t&&t.ctrlKey?window.open(e):nav.go(e,t)}}}}]);try{stManager.done("cmodules/bundles/92d561a0bfe326994ae42c79e0aa3e55.e616d8772e70fb24cae7.js")}catch(e){}